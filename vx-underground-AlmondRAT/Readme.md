# almondRAT 
https://vx-underground.org/Samples/Families/AlmondRAT
<br> <br> 

![image](https://github.com/user-attachments/assets/1560e26b-ea7c-428b-9e71-1efb5dce81c5)

Doing analysis on the file type shows that it's a dotnet exe. So loading it into dnspy will give us an easier time reversing it due to the nature of C# 
<br> <br> 
Looking at the main function of the program it's calling Mutex <br> 
![image](https://github.com/user-attachments/assets/d5c7ec9f-5975-44ad-8a37-4f98b7bab2c5)
<br> 
This resource gives a pretty good explanation of what Mutex does. 
<br> https://dotnettutorials.net/lesson/mutex-in-multithreading/#google_vignette <br> 
Essentially it checks if the program is currently running, if it is then it will not execute the Program.StartClient function. Otherwise, the program will continue execution. This is a good way to track if the malware is already being ran on the system. 

<br> I'm going to be doing some dynamic analysis to see what some other values are in the functions. To make sure that the program continues running im going to edit the Program class to make sure it continues no matter what. 
<br> 
![image](https://github.com/user-attachments/assets/5e44888c-1081-4fb8-8157-d163eb9d71cc)

<br> ![image](https://github.com/user-attachments/assets/b9c8008f-b9a0-4ade-af03-8eb556b744de)
<br> ![image](https://github.com/user-attachments/assets/bf15e995-29b4-4638-aa90-167210d9b808)

<br> Now we can follow along to see any potential hidden data stepping through the program while it's running 
<br> There's some base64 encoded text. Once its decrypted it leads to an ip. Could be there C2 server. <br> 
![image](https://github.com/user-attachments/assets/ac1f28fc-7ce0-437d-a4aa-f16887bebfa4)
<br> ![image](https://github.com/user-attachments/assets/addc4e48-2aa3-4ee0-b40b-d9b245707d66)
<br> 

It proceeds to get all the info from the computer like the os name and drives. Then it initiates a connection 
<br> 
![image](https://github.com/user-attachments/assets/67b65f3b-8f11-4b7f-9b0b-badc9a91c0b4)
## Connecting to the malware 
Since the malware is trying to connect to a known ip address, I had an idea to make the Windows VM and my ubuntu machine on the same network and then configure my ubuntu machine to be the malicious ip address. All the communication can be done by NOT allowing the virtual machines to connect to the internet. So we're "tricking" the malware to thinking that we have connected the real ip. This can all be done using virtual box network interface of host-only for both virtual machines and then manually changing the ip addresses. 
https://www.reddit.com/r/virtualbox/comments/n8i1sj/do_i_need_virtualbox_hostonly_ethernet_adapter/

![image](https://github.com/user-attachments/assets/70ace853-259e-4eca-b7a8-653f52551edc)
<br> <br> going into Windows settings to configure the ip so it's in the same subnet 
<br><br> 
![image](https://github.com/user-attachments/assets/0b2a88c9-2e52-4644-80d9-768dcb57f128)
<br> <br> 
--> properties <br> <br> 
![image](https://github.com/user-attachments/assets/18d511ce-1722-45df-8003-77d7644cd541)
<br> <br> 
--> properties <br> <br> 
![image](https://github.com/user-attachments/assets/9abfc5ea-3593-4b88-88ee-e2884825d2fa)
<br> ![image](https://github.com/user-attachments/assets/c09bc4d5-d436-46df-b229-b121a3fe99d2)
<br><br> Windows machine is in the subnet so now ubuntu vm. The below ip is the one uncovered from the malware 

<br> 

![image](https://github.com/user-attachments/assets/17ba68fb-0bb6-451b-85f1-3f08bef6fddb)
<br> <br> When doing this I kept getting a response regarding the hostname, ubuntu1, indicating to me that it couldn't resolve (or so i thought). I'm not sure if it's neccessary but I changed the hosts file on the windows machine thinking it would resolve. I don't fully understand why that didn't work for me... <br> 

![image](https://github.com/user-attachments/assets/0fa76f13-8ce5-4bdc-b3e7-15e6ced6b23b)

![image](https://github.com/user-attachments/assets/254eed3b-f6cd-494c-85f3-4bd121c82492)

<br> 

![image](https://github.com/user-attachments/assets/135ae7a4-fbe8-4bfd-91bf-4a96a56842de)

<br> ARP packets are being sent to the ubuntu vm posing as the hacker machine so there's some connection happening. I really wanted to make it work so I resorted to asking chatgpt. It decided to implement something I've never used before called netplan. After this I'm going to do some more research on why my method wasn't working but this one did. 
<br> <br> 
![image](https://github.com/user-attachments/assets/31b8fd59-088d-4536-ac44-78a3993e9a57)
<br><br> 
![image](https://github.com/user-attachments/assets/99f98116-758a-4786-ba4b-b91ad773aebd)
<br> <br> 
![image](https://github.com/user-attachments/assets/e82ec680-1122-4df0-a283-9768f23261d6)
<br> <br> 
Pings started coming through 
<br><br> 
![image](https://github.com/user-attachments/assets/a0a79228-2cbf-46ff-b862-6a76ae85632d)
<br> <br> 
![image](https://github.com/user-attachments/assets/4dcdb30c-bfda-4bac-b09f-1557bce68b6c)

<br><br> Finally, we can setup a listener on the ubuntu vm posing as the hacker and see what kind of information is being sent from the malware. ðŸ˜Ž

<br> 
To start, it sends system information separated by asterisks 
<br>

![image](https://github.com/user-attachments/assets/3e59f1f8-675d-43bb-aefb-86c304a9aed3)
<br><br> 
It then calls CommWithServer(socket).StartCommWithServer()

This function is asking for user input from the connection. Based on the code it's some encoded text that only decodes to bytes when put into a base64 decoder. So editing the class to make an instance of the variable will allow us to see what is the information that needs to be passed so the program can continue to run. 

<br> 

![image](https://github.com/user-attachments/assets/07132fba-1468-4f3d-b7a3-4e50b34e083c)
<br> 
The word to send is DRIVE 
<br> ![image](https://github.com/user-attachments/assets/1a595063-4bbb-405b-8083-3800bb5e1c00)
<br> <br> Since this is a RAT each base64 encoded text is actually a commmand that the attacker runs to perform a certain action. Stepping through the program we'll see each check the malware makes for what word was sent <br> <br> 
<br> REFRESH <br> <br> 
![image](https://github.com/user-attachments/assets/f5c36a7a-bb5e-4fd1-a399-6a8eb2a99386)
<br> <br> 
DIR <br> <br> 
![image](https://github.com/user-attachments/assets/72b089b4-d811-4a27-b8c5-12655ea6bfcf)
<br> <br> DOWNLOAD 
<br><br> 
![image](https://github.com/user-attachments/assets/264067f1-feac-437e-ac83-18a80fc41a38)

<br> <br> UPLOAD <br> <br> 
![image](https://github.com/user-attachments/assets/df281e23-5b08-43a9-9827-68f4a135ba9c)
<br> <br> DELETE <br> <br> 
![image](https://github.com/user-attachments/assets/3577c094-d901-4714-91bd-2c0c09e962d3)
<br> <br> CMD <br> <br> 
![image](https://github.com/user-attachments/assets/17db6ea2-dc5b-4105-aa0b-accf17fe196b)
<br> <br> To be continued 
